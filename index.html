<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Management MIS | Professional</title>
    <!-- External Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root { 
            --bg: #f8fafc;
            --card: #ffffff;
            --accent: #0284c7;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --table-header: #f8fafc;
            --table-hover: rgba(2, 132, 199, 0.03);
            --nav-bg: #ffffff;
            --update-bg: #e0f2fe;
        }

        body.dark-mode {
            --bg: #0f172a; 
            --card: #1e293b; 
            --accent: #38bdf8; 
            --text-main: #f1f5f9;
            --text-muted: #cbd5e1; 
            --border: #334155;
            --table-header: #1e293b;
            --table-hover: rgba(56, 189, 248, 0.05);
            --nav-bg: #1e293b;
            --update-bg: rgba(56, 189, 248, 0.1);
        }
        
        body { 
            background-color: var(--bg); 
            color: var(--text-main); 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; 
            min-height: 100vh;
            transition: all 0.3s ease;
            overflow-x: hidden;
        }

        /* Mobile Specific Fixes */
        @media (max-width: 576px) {
            .container { padding-left: 15px; padding-right: 15px; }
            .h3 { font-size: 1.3rem !important; }
            .h2 { font-size: 1.6rem !important; }
            .stat-card { padding: 15px !important; }
            .header-title { font-size: 1rem !important; }
        }

        /* Header UI (Fixed Overlap) */
        .header-title { 
            font-weight: 900; 
            color: #0284c7; 
            letter-spacing: 1px; 
            display: block;
            margin-bottom: 8px; /* Increased space between title and time */
        }
        
        #timestamp-badge {
            display: inline-flex;
            align-items: center;
            background: var(--update-bg);
            border: 1.5px solid #0284c7;
            color: #0284c7;
            padding: 4px 14px;
            border-radius: 10px;
            font-weight: 800;
            font-size: 0.85rem;
            margin-bottom: 8px; /* Extra room before subtitle */
            line-height: 1;
        }

        .icon-badge {
            background: var(--update-bg);
            border: 1.5px solid #0284c7;
            color: #0284c7;
            padding: 6px;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .subtitle { color: #8a8a8a; font-size: 0.8rem; font-weight: 600; display: block; }

        /* Navigation Pills */
        .nav-pills { 
            background: var(--nav-bg); 
            padding: 5px; 
            border-radius: 50px; 
            width: 100%; 
            max-width: 340px;
            margin: 20px auto 25px; 
            border: 1.5px solid var(--border);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            display: flex;
        }

        .nav-pills .nav-item { flex: 1; }

        .nav-link { 
            width: 100%;
            color: var(--text-muted); 
            border-radius: 50px !important; 
            padding: 10px 0; 
            border: none; 
            font-size: 0.85rem; 
            font-weight: 700;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-link.active { 
            background: #0284c7 !important; 
            color: white !important; 
            box-shadow: 0 6px 15px rgba(2, 132, 199, 0.3);
        }

        /* Stat Cards */
        .stat-card { 
            background: var(--card); 
            border: 1.5px solid var(--border); 
            border-radius: 18px; 
            padding: 20px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-label {
            color: #8e9aaf;
            display: block;
            margin-bottom: 6px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.65rem;
        }

        /* Filters */
        .filter-select { 
            background-color: var(--card); 
            color: var(--text-main); 
            border: 1.5px solid var(--border); 
            border-radius: 12px; 
            font-size: 0.9rem; 
            padding: 12px;
            font-weight: 600;
        }

        .active-filter-summary {
            background: #e0f2fe;
            border: 1.5px solid #0284c7;
            color: #0284c7;
            padding: 12px;
            border-radius: 12px;
            font-weight: 800;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        /* Table */
        .table-container { 
            background: var(--card); 
            border-radius: 18px; 
            overflow: hidden; 
            border: 1.5px solid var(--border); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.04);
        }

        .table thead th { 
            background: var(--table-header); 
            color: #0284c7; 
            font-weight: 800;
            border-bottom: 1.5px solid var(--border);
            text-transform: uppercase;
            font-size: 0.7rem;
            padding: 15px 12px;
        }

        .text-contribution { color: var(--text-main); font-weight: 800; }

        /* Settings Icon */
        .settings-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 1.5px solid var(--border);
            color: #0284c7;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            cursor: pointer;
        }
    </style>
</head>
<body class="light-mode">

<div class="container py-4">
    <!-- Header (Screenshot Adjusted) -->
    <header class="d-flex justify-content-between align-items-start mb-2">
        <div class="flex-grow-1">
            <h6 class="header-title text-uppercase">PRODUCTIVITY HUB</h6>
            <div id="timestamp-badge">
                <span id="live-clock">--:--:-- --</span>
            </div>
            <p class="subtitle mb-0">Management MIS Dashboard</p>
        </div>
        <div class="d-flex flex-column align-items-end gap-3">
            <div class="icon-badge">
                <i class="far fa-clock"></i>
            </div>
            <div class="settings-btn" onclick="toggleTheme()">
                <i class="fas fa-cog" id="theme-icon"></i>
            </div>
        </div>
    </header>

    <!-- Navigation Pills -->
    <ul class="nav nav-pills" id="pills-tab" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#view-chart">
                <i class="fas fa-chart-pie me-2"></i>Analytics
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#view-table">
                <i class="fas fa-users-cog me-2"></i>User Details
            </button>
        </li>
    </ul>

    <div class="tab-content" id="pills-tabContent">
        <!-- Analytics View -->
        <div class="tab-pane fade show active" id="view-chart">
            <div class="row g-3 mb-4 text-center">
                <div class="col-6">
                    <div class="stat-card" style="border: 1.5px solid #0284c7">
                        <span class="stat-label">Target</span>
                        <span id="target-val" class="h2 fw-bold" style="color: #1a1a1a;">24,500</span>
                    </div>
                </div>
                <div class="col-6">
                    <div class="stat-card">
                        <span class="stat-label">Achieved</span>
                        <span id="achieved-val" class="h2 fw-bold text-info">0</span>
                    </div>
                </div>
            </div>
            <div class="stat-card p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h6 class="m-0 fw-bold">Contribution</h6>
                    <select id="chart-dept-filter" class="form-select filter-select w-auto py-1 px-3" style="font-size: 0.75rem;" onchange="updateAnalytics()">
                        <option value="all">All Depts</option>
                        <option value="GRN">GRN</option>
                        <option value="Picking">Picking</option>
                    </select>
                </div>
                <div style="position: relative; height: 300px;">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
        </div>

        <!-- User Details View -->
        <div class="tab-pane fade" id="view-table">
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <select id="bldg-filter" class="form-select filter-select" onchange="applyWebFilters()">
                        <option value="all">All Buildings</option>
                        <option value="bldg3">Building 3</option>
                        <option value="bldg5">Building 5</option>
                    </select>
                </div>
                <div class="col-6">
                    <select id="dept-filter" class="form-select filter-select" onchange="applyWebFilters()">
                        <option value="all">All Depts</option>
                        <option value="GRN">GRN</option>
                        <option value="Picking">Picking</option>
                    </select>
                </div>
            </div>

            <div class="active-filter-summary mb-4 shadow-sm">
                <span id="summary-bldg" class="text-truncate">BUILDING: ALL</span>
                <span class="opacity-25">|</span>
                <span id="summary-dept" class="text-truncate">DEPT: ALL</span>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-6">
                    <div class="stat-card p-3 text-center" style="background: #f1f5f9; border: none;">
                        <span class="stat-label">Total Actors</span>
                        <span id="total-actors-count" class="fw-bold h4 mb-0">0</span>
                    </div>
                </div>
                <div class="col-6">
                    <div class="stat-card p-3 text-center" style="background: #f1f5f9; border: none;">
                        <span class="stat-label">Total Quantity</span>
                        <span id="total-qty-sum" class="fw-bold h4 mb-0" style="color: #0284c7;">0</span>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <table class="table table-hover text-center" id="user-table">
                    <thead>
                        <tr>
                            <th class="text-start ps-4">Actor</th>
                            <th class="text-end" onclick="toggleSort()" style="cursor:pointer">Qty <i class="fas fa-sort small ms-1"></i></th>
                            <th class="text-end pe-4">Contribution</th>
                        </tr>
                    </thead>
                    <tbody id="user-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://productivity-tracker-e3538-default-rtdb.firebaseio.com" };
    
    try {
        firebase.initializeApp(firebaseConfig);
    } catch (e) {}
    
    const db = firebase.database();
    let chart;
    let rawData = [];
    let sortAsc = false;
    let currentGlobalAchievedTotal = 0;

    const DEPARTMENT_TARGETS = { 'all': 24500, 'GRN': 15000, 'Picking': 9500 };

    const mockData = [
        { Building: "WMS_ENTOMA_B5", Department: "GRN", Actor: "anithadas", Qty: 1639 },
        { Building: "WMS_ENTOMA_B5", Department: "GRN", Actor: "nikita.m", Qty: 1618 },
        { Building: "WMS_ENTOMA_B5", Department: "GRN", Actor: "madhukumari", Qty: 1507 },
        { Building: "WMS_ENTOMA_B5", Department: "GRN", Actor: "priti.p", Qty: 1486 },
        { Building: "WMS_ENTOMA_B5", Department: "GRN", Actor: "sunilnahak", Qty: 1236 },
        { Building: "WMS_ENTOMA_B3", Department: "Picking", Actor: "tituswail", Qty: 1126 },
        { Building: "WMS_ENTOMA_B3", Department: "Picking", Actor: "ashok.marko", Qty: 984 },
        { Building: "WMS_ENTOMA_B5", Department: "GRN", Actor: "jaya", Qty: 928 },
        { Building: "WMS_ENTOMA_B3", Department: "Picking", Actor: "ranjith.dehury", Qty: 874 }
    ];

    function toggleTheme() {
        const isDark = document.body.classList.toggle('dark-mode');
        document.getElementById('theme-icon').className = isDark ? 'fas fa-sun' : 'fas fa-cog';
        updateAnalytics(); 
    }

    function updateClock() {
        const now = new Date();
        document.getElementById('live-clock').innerText = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
    }
    setInterval(updateClock, 1000);
    updateClock();

    function initializeApp() {
        db.ref('detailed_productivity').on('value', (snapshot) => {
            const data = snapshot.val();
            rawData = data ? Object.values(data) : [...mockData];
            processAndRender();
        }, () => {
            rawData = [...mockData];
            processAndRender();
        });
    }

    function processAndRender() {
        rawData.sort((a, b) => Number(b.Qty || 0) - Number(a.Qty || 0));
        currentGlobalAchievedTotal = rawData.reduce((acc, r) => acc + Number(r.Qty || 0), 0);
        updateAnalytics(); 
        renderTable(rawData);
        applyWebFilters(); 
    }

    function renderTable(data) {
        const tableBody = document.getElementById('user-table-body');
        tableBody.innerHTML = "";
        data.forEach((row) => {
            const qty = Number(row.Qty || 0);
            const contribution = currentGlobalAchievedTotal > 0 ? ((qty / currentGlobalAchievedTotal) * 100).toFixed(1) : 0;
            tableBody.innerHTML += `
                <tr class="user-row" data-bldg="${row.Building || ''}" data-dept="${row.Department || ''}" data-qty="${qty}">
                    <td class="text-start ps-4 py-3 fw-bold">${row.Actor || 'N/A'}</td>
                    <td class="text-end fw-bold" style="color: #0284c7;">${qty.toLocaleString()}</td>
                    <td class="text-end pe-4 text-contribution">${contribution}%</td>
                </tr>`;
        });
    }

    function applyWebFilters() {
        const bSelect = document.getElementById('bldg-filter');
        const dSelect = document.getElementById('dept-filter');
        const bldgVal = bSelect.value.toLowerCase();
        const deptVal = dSelect.value.toLowerCase();
        const rows = document.querySelectorAll('.user-row');

        let vCount = 0, vQty = 0;
        rows.forEach(row => {
            const rBldg = String(row.getAttribute('data-bldg')).toLowerCase();
            const rDept = String(row.getAttribute('data-dept')).toLowerCase();
            const bMatch = bldgVal === 'all' || rBldg.includes(bldgVal.replace('building', '').replace('bldg', '').trim());
            const dMatch = deptVal === 'all' || rDept === deptVal;
            if (bMatch && dMatch) {
                row.style.display = "";
                vCount++;
                vQty += Number(row.getAttribute('data-qty'));
            } else {
                row.style.display = "none";
            }
        });

        document.getElementById('total-actors-count').innerText = vCount.toLocaleString();
        document.getElementById('total-qty-sum').innerText = vQty.toLocaleString();
        document.getElementById('summary-bldg').innerText = `BUILDING: ${bSelect.options[bSelect.selectedIndex].text.toUpperCase()}`;
        document.getElementById('summary-dept').innerText = `DEPT: ${dSelect.options[dSelect.selectedIndex].text.toUpperCase()}`;
    }

    function updateAnalytics() {
        const deptFilter = document.getElementById('chart-dept-filter').value;
        let b3Filtered = 0, b5Filtered = 0;

        rawData.forEach(r => {
            const rDept = String(r.Department || "").toLowerCase();
            const fDept = deptFilter.toLowerCase();
            if (fDept === 'all' || rDept === fDept) {
                const bldg = String(r.Building || "").toLowerCase();
                const qty = Number(r.Qty || 0);
                if (bldg.includes('3')) b3Filtered += qty;
                else if (bldg.includes('5')) b5Filtered += qty;
            }
        });

        const achieved = b3Filtered + b5Filtered;
        const target = DEPARTMENT_TARGETS[deptFilter] || 24500;
        document.getElementById('achieved-val').innerText = achieved.toLocaleString();
        document.getElementById('target-val').innerText = target.toLocaleString();
        updateChart(b3Filtered, b5Filtered, target);
    }

    function toggleSort() {
        sortAsc = !sortAsc;
        rawData.sort((a, b) => sortAsc ? Number(a.Qty || 0) - Number(b.Qty || 0) : Number(b.Qty || 0) - Number(a.Qty || 0));
        renderTable(rawData);
        applyWebFilters();
    }

    function updateChart(b3, b5, target) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        const achieved = b3 + b5;
        const remaining = Math.max(0, target - achieved);
        const labelColor = getComputedStyle(document.body).getPropertyValue('--text-muted').trim();

        if (chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Bldg 3', 'Bldg 5', 'Remaining'],
                datasets: [{
                    data: [b3, b5, remaining],
                    backgroundColor: ['#38bdf8', '#818cf8', '#f1f5f9'],
                    hoverOffset: 12,
                    borderWidth: 0,
                    borderRadius: 5
                }]
            },
            options: { 
                maintainAspectRatio: false,
                cutout: '75%', 
                plugins: { 
                    legend: { position: 'bottom', labels: { color: labelColor, padding: 25, usePointStyle: true, font: { size: 11, weight: '700' } } }
                } 
            }
        });
    }

    window.onload = initializeApp;
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
