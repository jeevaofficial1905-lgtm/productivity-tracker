<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Management MIS | Professional</title>
    <!-- External Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root { 
            --bg: #0f172a; 
            --card: #1e293b; 
            --accent: #38bdf8; 
            --text-main: #f1f5f9;
            --text-muted: #cbd5e1; 
            --border: #334155;
            --table-header: #1e293b;
            --table-hover: rgba(56, 189, 248, 0.05);
            --nav-bg: #1e293b;
            --update-bg: rgba(56, 189, 248, 0.1);
        }

        body.light-mode {
            --bg: #f8fafc;
            --card: #ffffff;
            --accent: #0284c7;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --table-header: #f8fafc;
            --table-hover: rgba(2, 132, 199, 0.03);
            --nav-bg: #ffffff;
            --update-bg: rgba(2, 132, 199, 0.1);
        }
        
        body { 
            background-color: var(--bg); 
            color: var(--text-main); 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; 
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
        }

        @media (max-width: 576px) {
            .container { padding-left: 10px; padding-right: 10px; }
            .h2 { font-size: 1.6rem !important; }
            .nav-link { padding: 10px 18px !important; font-size: 0.85rem !important; }
            .stat-card { padding: 20px 12px !important; }
            header h6 { font-size: 1.1rem !important; }
        }

        .nav-pills { 
            background: var(--nav-bg); 
            padding: 6px; 
            border-radius: 50px; 
            width: fit-content; 
            margin: 6px auto 20px; 
            border: 1px solid var(--border);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .nav-link { 
            color: var(--text-muted); 
            border-radius: 50px !important; 
            padding: 10px 28px; 
            border: none; 
            font-size: 0.95rem; 
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .nav-link.active { 
            background: var(--accent) !important; 
            color: white !important; 
            box-shadow: 0 4px 12px rgba(56, 189, 248, 0.4);
        }

        .stat-card { 
            background: var(--card); 
            border: 1px solid var(--border); 
            border-radius: 16px; 
            padding: 24px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .stat-label {
            color: var(--text-muted);
            display: block;
            margin-bottom: 8px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            font-size: 0.75rem;
            opacity: 1 !important;
        }

        .filter-select { 
            background-color: var(--card); 
            color: var(--text-main); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            font-size: 0.95rem; 
            padding: 12px;
        }

        .chart-filter {
            padding: 4px 12px;
            font-size: 0.8rem;
            background: var(--bg);
            color: var(--accent);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-weight: 700;
        }

        .active-filter-summary {
            background: var(--update-bg);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 12px;
            border-radius: 12px;
            font-weight: 900;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .table-container { 
            background: var(--card); 
            border-radius: 18px; 
            overflow: hidden; 
            border: 1px solid var(--border); 
        }

        .table { 
            margin-bottom: 0; 
            vertical-align: middle; 
            color: var(--text-main);
        }

        .table thead th { 
            background: var(--table-header); 
            color: var(--accent); 
            font-weight: 800;
            border-bottom: 2px solid var(--border);
            text-transform: uppercase;
            font-size: 0.75rem;
            padding: 18px 10px;
        }

        .table tbody tr { border-bottom: 1px solid var(--border); }

        .text-contribution {
            color: var(--accent);
            font-weight: 800;
        }

        #last-updated {
            font-size: 0.75rem;
            background: var(--update-bg);
            padding: 6px 14px;
            border-radius: 8px;
            border: 1px solid var(--accent);
            color: var(--accent);
            font-weight: 800;
        }

        .theme-toggle {
            cursor: pointer;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--accent);
            transition: all 0.2s ease;
        }
    </style>
</head>
<body class="dark-mode">

<div class="container py-4">
    <header class="d-flex justify-content-between align-items-center mb-4">
        <div class="flex-grow-1">
            <h6 class="fw-bold text-uppercase tracking-wider mb-1" style="color: var(--accent); letter-spacing: 0.15em;">
                PRODUCTIVITY HUB 
                <span id="last-updated" class="ms-3"></span>
            </h6>
            <p class="text-muted small mb-0 fw-bold opacity-75">Management MIS Dashboard</p>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()" title="Switch Theme">
            <i class="fas fa-moon" id="theme-icon"></i>
        </button>
    </header>

    <ul class="nav nav-pills shadow-sm" id="pills-tab" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#view-chart">
                <i class="fas fa-chart-pie me-2"></i>Analytics
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#view-table">
                <i class="fas fa-users-cog me-2"></i>User Details
            </button>
        </li>
    </ul>

    <div class="tab-content" id="pills-tabContent">
        <!-- Analytics View -->
        <div class="tab-pane fade show active" id="view-chart">
            <div class="row g-3 mb-4 text-center">
                <div class="col-6">
                    <div class="stat-card" style="border: 1px solid var(--accent)">
                        <span class="stat-label">TARGET</span>
                        <span id="target-val" class="h2 fw-bold">24,500</span>
                    </div>
                </div>
                <div class="col-6">
                    <div class="stat-card">
                        <span class="stat-label">ACHIEVED</span>
                        <span id="achieved-val" class="h2 fw-bold text-info">0</span>
                    </div>
                </div>
            </div>
            <div class="stat-card shadow-lg">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="m-0 fw-bold">Contribution</h6>
                    <div>
                        <select id="chart-dept-filter" class="form-select chart-filter" onchange="updateAnalytics()">
                            <option value="all">All Depts</option>
                            <option value="GRN">GRN</option>
                            <option value="Picking">Picking</option>
                        </select>
                    </div>
                </div>
                <div style="position: relative; height: 320px;">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
        </div>

        <!-- User Details View -->
        <div class="tab-pane fade" id="view-table">
            <div class="row g-3 mb-3">
                <div class="col-6">
                    <select id="bldg-filter" class="form-select filter-select" onchange="applyWebFilters()">
                        <option value="all">All Buildings</option>
                        <option value="bldg3">Bldg 3</option>
                        <option value="bldg5">Bldg 5</option>
                    </select>
                </div>
                <div class="col-6">
                    <select id="dept-filter" class="form-select filter-select" onchange="applyWebFilters()">
                        <option value="all">All Depts</option>
                        <option value="GRN">GRN</option>
                        <option value="Picking">Picking</option>
                    </select>
                </div>
            </div>

            <div id="filter-summary-container" class="mb-3">
                <div class="active-filter-summary shadow-sm mb-3">
                    <span id="summary-bldg">BUILDING: ALL</span>
                    <span class="opacity-25">|</span>
                    <span id="summary-dept">DEPT: ALL</span>
                </div>
                <div class="row g-2">
                    <div class="col-6">
                        <div class="stat-card p-3 text-center">
                            <small class="stat-label mb-1">Total Actors</small>
                            <span id="total-actors-count" class="fw-bold h4 mb-0">0</span>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-card p-3 text-center">
                            <small class="stat-label mb-1">Total Quantity</small>
                            <span id="total-qty-sum" class="fw-bold h4 mb-0 text-info">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="table-container shadow">
                <table class="table table-hover text-center" id="user-table">
                    <thead>
                        <tr>
                            <th class="py-3 text-start ps-4">Actor</th>
                            <th class="py-3 text-end" onclick="toggleSort()" style="cursor:pointer">
                                Qty <i class="fas fa-sort small ms-1 opacity-50"></i>
                            </th>
                            <th class="py-3 text-end pe-4">Contribution</th>
                        </tr>
                    </thead>
                    <tbody id="user-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://productivity-tracker-e3538-default-rtdb.firebaseio.com" };
    
    try {
        firebase.initializeApp(firebaseConfig);
    } catch (e) {
        console.warn("Firebase Init Error:", e.message);
    }
    
    const db = firebase.database();
    let chart;
    let rawData = [];
    let sortAsc = false;
    let globalTotalAchieved = 0;

    // Fixed Target mapping per department selection
    const DEPARTMENT_TARGETS = {
        'all': 24500,
        'grn': 15000,
        'picking': 9500
    };

    const mockData = [
        { Building: "WMS_ENTOMA_B5", Department: "GRN", Actor: "anithadas", Qty: 1639 },
        { Building: "WMS_ENTOMA_B5", Department: "GRN", Actor: "nikita.m", Qty: 1618 },
        { Building: "WMS_ENTOMA_B5", Department: "GRN", Actor: "madhukumari", Qty: 1507 },
        { Building: "WMS_ENTOMA_B5", Department: "GRN", Actor: "priti.p", Qty: 1486 },
        { Building: "WMS_ENTOMA_B3", Department: "Picking", Actor: "tituswail", Qty: 1126 },
        { Building: "WMS_ENTOMA_B3", Department: "Picking", Actor: "ashok.marko", Qty: 984 },
        { Building: "WMS_ENTOMA_B5", Department: "GRN", Actor: "jaya", Qty: 928 },
        { Building: "WMS_ENTOMA_B3", Department: "Picking", Actor: "ranjith.dehury", Qty: 874 }
    ];

    function initTheme() {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        if (savedTheme === 'light') {
            document.body.classList.add('light-mode');
            updateThemeIcon(true);
        }
    }

    function toggleTheme() {
        const isLight = document.body.classList.toggle('light-mode');
        localStorage.setItem('theme', isLight ? 'light' : 'dark');
        updateThemeIcon(isLight);
        updateAnalytics(); 
    }

    function updateThemeIcon(isLight) {
        const icon = document.getElementById('theme-icon');
        icon.className = isLight ? 'fas fa-sun' : 'fas fa-moon';
    }

    function updateTimestamp() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        document.getElementById('last-updated').innerHTML = `<i class="fas fa-clock me-1"></i>${timeStr}`;
    }

    function initializeApp() {
        initTheme();
        db.ref('detailed_productivity').on('value', (snapshot) => {
            const data = snapshot.val();
            rawData = data ? Object.values(data) : [...mockData];
            processAndRender();
        }, (error) => {
            console.warn("Firebase Read Failed:", error);
            rawData = [...mockData];
            processAndRender();
        });
    }

    function processAndRender() {
        rawData.sort((a, b) => Number(b.Qty || 0) - Number(a.Qty || 0));
        
        // Sum total achieved for contribution percentages
        globalTotalAchieved = 0;
        rawData.forEach(r => {
            globalTotalAchieved += Number(r.Qty || 0);
        });
        
        updateAnalytics(); 
        renderTable(rawData);
        updateTimestamp();
        applyWebFilters(); 
    }

    function renderTable(data) {
        const tableBody = document.getElementById('user-table-body');
        tableBody.innerHTML = "";
        
        data.forEach((row) => {
            const qty = Number(row.Qty || 0);
            const contribution = globalTotalAchieved > 0 ? ((qty / globalTotalAchieved) * 100).toFixed(1) : 0;
            tableBody.innerHTML += `
                <tr class="user-row" data-bldg="${row.Building || ''}" data-dept="${row.Department || ''}" data-qty="${qty}">
                    <td class="text-start ps-4 py-3 fw-bold">${row.Actor || 'N/A'}</td>
                    <td class="text-end text-info fw-bold">${qty.toLocaleString()}</td>
                    <td class="text-end pe-4 text-contribution">${contribution}%</td>
                </tr>`;
        });
    }

    function applyWebFilters() {
        const bldgSelect = document.getElementById('bldg-filter');
        const deptSelect = document.getElementById('dept-filter');
        const bldgVal = bldgSelect.value.toLowerCase();
        const deptVal = deptSelect.value.toLowerCase();
        const rows = document.querySelectorAll('.user-row');

        let visibleCount = 0;
        let visibleQtySum = 0;

        rows.forEach(row => {
            const rowBldg = String(row.getAttribute('data-bldg') || "").toLowerCase();
            const rowDept = String(row.getAttribute('data-dept') || "").toLowerCase();
            
            const bMatch = bldgVal === 'all' || rowBldg.includes(bldgVal);
            const dMatch = deptVal === 'all' || rowDept === deptVal;
            
            if (bMatch && dMatch) {
                row.style.display = "";
                visibleCount++;
                visibleQtySum += Number(row.getAttribute('data-qty') || 0);
            } else {
                row.style.display = "none";
            }
        });

        document.getElementById('summary-bldg').innerHTML = `<i class="fas fa-building me-1 opacity-50"></i> BUILDING: ${bldgSelect.options[bldgSelect.selectedIndex].text.toUpperCase()}`;
        document.getElementById('summary-dept').innerHTML = `<i class="fas fa-layer-group me-1 opacity-50"></i> DEPT: ${deptSelect.options[deptSelect.selectedIndex].text.toUpperCase()}`;
        document.getElementById('total-actors-count').innerText = visibleCount.toLocaleString();
        document.getElementById('total-qty-sum').innerText = visibleQtySum.toLocaleString();
    }

    function updateAnalytics() {
        const filterVal = document.getElementById('chart-dept-filter').value.toLowerCase();
        let b3Filtered = 0, b5Filtered = 0;

        // Perform calculation locally on rawData array
        rawData.forEach(r => {
            const rowDept = String(r.Department || "").toLowerCase();
            const isMatch = (filterVal === 'all' || rowDept === filterVal);
            
            if (isMatch) {
                const bldg = String(r.Building || "").toLowerCase();
                const qty = Number(r.Qty || 0);
                if (bldg.includes('3')) b3Filtered += qty;
                else if (bldg.includes('5')) b5Filtered += qty;
            }
        });

        const currentAchieved = b3Filtered + b5Filtered;
        const currentTarget = DEPARTMENT_TARGETS[filterVal] || 24500;

        // Force UI updates immediately
        document.getElementById('achieved-val').innerText = currentAchieved.toLocaleString();
        document.getElementById('target-val').innerText = currentTarget.toLocaleString();
        
        updateChart(b3Filtered, b5Filtered, currentTarget);
    }

    function toggleSort() {
        sortAsc = !sortAsc;
        rawData.sort((a, b) => sortAsc ? Number(a.Qty || 0) - Number(b.Qty || 0) : Number(b.Qty || 0) - Number(a.Qty || 0));
        renderTable(rawData);
        applyWebFilters();
    }

    function updateChart(b3, b5, target) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        const achieved = b3 + b5;
        const remaining = Math.max(0, target - achieved);
        const labelColor = getComputedStyle(document.body).getPropertyValue('--text-muted').trim();

        if (chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Bldg 3', 'Bldg 5', 'Remaining'],
                datasets: [{
                    data: [b3, b5, remaining],
                    backgroundColor: ['#38bdf8', '#818cf8', '#94a3b833'],
                    hoverOffset: 15,
                    borderWidth: 0,
                    borderRadius: 5
                }]
            },
            options: { 
                maintainAspectRatio: false,
                cutout: '72%', 
                plugins: { 
                    legend: { 
                        position: 'bottom', 
                        labels: { color: labelColor, padding: 25, usePointStyle: true, font: { size: 12, weight: '700' } } 
                    }
                } 
            }
        });
    }
    window.onload = initializeApp;
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
