<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Management MIS | Professional</title>
    <!-- External Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root { 
            --bg: #0f172a; 
            --card: #1e293b; 
            --accent: #38bdf8; 
            --text-main: #f1f5f9;
            --text-muted: #cbd5e1; 
            --border: #334155;
            --table-header: #1e293b;
            --table-hover: rgba(56, 189, 248, 0.05);
            --nav-bg: #1e293b;
            --update-bg: rgba(56, 189, 248, 0.1);
        }

        /* Light Mode Variables */
        body.light-mode {
            --bg: #f8fafc;
            --card: #ffffff;
            --accent: #0284c7;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --table-header: #f8fafc;
            --table-hover: rgba(2, 132, 199, 0.03);
            --nav-bg: #ffffff;
            --update-bg: rgba(2, 132, 199, 0.1);
        }
        
        body { 
            background-color: var(--bg); 
            color: var(--text-main); 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; 
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .nav-pills { 
            background: var(--nav-bg); 
            padding: 5px; 
            border-radius: 50px; 
            width: fit-content; 
            margin: 20px auto; 
            border: 1px solid var(--border);
        }

        .nav-link { 
            color: var(--text-muted); 
            border-radius: 50px !important; 
            padding: 8px 24px; 
            border: none; 
            font-size: 0.9rem; 
            transition: all 0.2s ease;
        }

        .nav-link.active { 
            background: var(--accent) !important; 
            color: white !important; 
            font-weight: 600; 
            box-shadow: 0 4px 12px rgba(56, 189, 248, 0.3);
        }

        .stat-card { 
            background: var(--card); 
            border: 1px solid var(--border); 
            border-radius: 16px; 
            padding: 20px; 
            transition: transform 0.2s ease, background-color 0.3s ease, border-color 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent);
        }

        .stat-label {
            color: var(--text-muted);
            display: block;
            margin-bottom: 4px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.75rem;
        }

        .filter-select { 
            background-color: var(--card); 
            color: var(--text-main); 
            border: 1px solid var(--border); 
            border-radius: 10px; 
            font-size: 0.9rem; 
            padding: 10px;
        }

        .chart-filter {
            padding: 2px 8px;
            font-size: 0.75rem;
            width: auto;
            min-width: 120px;
            background: var(--bg);
            color: var(--accent);
            border: 1px solid var(--border);
            border-radius: 6px;
        }

        .active-filter-summary {
            background: var(--update-bg);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 12px 15px;
            border-radius: 12px;
            font-weight: 800;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .table-container { 
            background: var(--card); 
            border-radius: 16px; 
            overflow: hidden; 
            border: 1px solid var(--border); 
        }

        .table { 
            margin-bottom: 0; 
            font-size: 0.95rem; 
            vertical-align: middle; 
            color: var(--text-main);
            border-color: var(--border);
        }

        .table thead th { 
            background: var(--table-header); 
            color: var(--accent); 
            font-weight: 700;
            border-bottom: 2px solid var(--border);
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.05em;
        }

        .table tbody tr {
            border-bottom: 1px solid var(--border);
            background: transparent;
        }

        .table-hover tbody tr:hover {
            background-color: var(--table-hover) !important;
        }

        .text-contribution {
            color: var(--accent);
            font-weight: 600;
            font-size: 0.85rem;
        }

        #last-updated {
            font-size: 0.8rem;
            text-transform: none;
            vertical-align: middle;
            background: var(--update-bg);
            padding: 4px 12px;
            border-radius: 6px;
            border: 1px solid var(--accent);
            color: var(--accent);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .theme-toggle {
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--accent);
            transition: all 0.2s ease;
        }
        .theme-toggle:hover {
            background: var(--border);
        }

        .tracking-wider { letter-spacing: 0.1em; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
    </style>
</head>
<body class="dark-mode">

<div class="container py-4">
    <header class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h6 class="fw-bold text-uppercase tracking-wider mb-2" style="color: var(--accent)">
                Productivity Hub 
                <span id="last-updated" class="ms-3 fw-bold"></span>
            </h6>
            <p class="text-muted small mb-0">Management MIS Dashboard</p>
        </div>
        <button class="theme-toggle shadow-sm" onclick="toggleTheme()" title="Toggle Light/Dark Mode">
            <i class="fas fa-moon" id="theme-icon"></i>
        </button>
    </header>

    <ul class="nav nav-pills shadow-sm" id="pills-tab" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#view-chart">
                <i class="fas fa-chart-pie me-2"></i>Analytics
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#view-table">
                <i class="fas fa-users me-2"></i>User Details
            </button>
        </li>
    </ul>

    <div class="tab-content" id="pills-tabContent">
        <!-- Analytics View -->
        <div class="tab-pane fade show active" id="view-chart">
            <div class="row g-3 mb-4 text-center">
                <div class="col-6">
                    <div class="stat-card">
                        <span class="stat-label">Target</span>
                        <span id="target-val" class="h3 fw-bold">0</span>
                    </div>
                </div>
                <div class="col-6">
                    <div class="stat-card">
                        <span class="stat-label">Achieved</span>
                        <span id="achieved-val" class="h3 fw-bold text-info">0</span>
                    </div>
                </div>
            </div>
            <div class="stat-card shadow-lg">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="m-0 fw-bold">Distribution by Building</h6>
                    <div>
                        <select id="chart-dept-filter" class="form-select chart-filter" onchange="updateAnalytics()">
                            <option value="all">All Depts</option>
                            <option value="GRN">GRN</option>
                            <option value="Picking">Picking</option>
                        </select>
                    </div>
                </div>
                <div style="position: relative; height: 300px;">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
        </div>

        <!-- User Details View -->
        <div class="tab-pane fade" id="view-table">
            <div class="row g-3 mb-3">
                <div class="col-6">
                    <select id="bldg-filter" class="form-select filter-select" onchange="applyWebFilters()">
                        <option value="all">All Buildings</option>
                        <option value="bldg3">Building 3</option>
                        <option value="bldg5">Building 5</option>
                    </select>
                </div>
                <div class="col-6">
                    <select id="dept-filter" class="form-select filter-select" onchange="applyWebFilters()">
                        <option value="all">All Depts</option>
                        <option value="GRN">GRN</option>
                        <option value="Picking">Picking</option>
                    </select>
                </div>
            </div>

            <div id="filter-summary-container" class="mb-3">
                <div class="active-filter-summary shadow-sm">
                    <span id="summary-bldg">BUILDING: ALL</span>
                    <span class="opacity-25">|</span>
                    <span id="summary-dept">DEPT: ALL</span>
                </div>
            </div>

            <div class="table-container shadow">
                <table class="table table-hover text-center" id="user-table">
                    <thead>
                        <tr>
                            <th class="py-3 text-start ps-4">Actor</th>
                            <th class="py-3 text-end" onclick="toggleSort()" style="cursor:pointer">
                                Qty <i class="fas fa-sort small ms-1 opacity-50"></i>
                            </th>
                            <th class="py-3 text-end pe-4">Contribution</th>
                        </tr>
                    </thead>
                    <tbody id="user-table-body">
                        <!-- Rows injected here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://productivity-tracker-e3538-default-rtdb.firebaseio.com" };
    
    try {
        firebase.initializeApp(firebaseConfig);
    } catch (e) {
        console.warn("Firebase Init Error:", e.message);
    }
    
    const db = firebase.database();
    let chart;
    let rawData = [];
    let sortAsc = false;
    let totalAchievedValue = 0;

    const mockData = [
        { Building: "bldg3", Department: "GRN", Actor: "John Doe", Qty: 450 },
        { Building: "bldg3", Department: "Picking", Actor: "Sarah Smith", Qty: 320 },
        { Building: "bldg5", Department: "GRN", Actor: "Mike Ross", Qty: 580 },
        { Building: "bldg5", Department: "Picking", Actor: "Anna Bell", Qty: 210 },
        { Building: "bldg3", Department: "GRN", Actor: "James Bond", Qty: 150 },
        { Building: "bldg5", Department: "Picking", Actor: "Harvey Specter", Qty: 600 }
    ];

    function initTheme() {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        if (savedTheme === 'light') {
            document.body.classList.add('light-mode');
            updateThemeIcon(true);
        }
    }

    function toggleTheme() {
        const isLight = document.body.classList.toggle('light-mode');
        localStorage.setItem('theme', isLight ? 'light' : 'dark');
        updateThemeIcon(isLight);
        updateAnalytics(); 
    }

    function updateThemeIcon(isLight) {
        const icon = document.getElementById('theme-icon');
        icon.className = isLight ? 'fas fa-sun' : 'fas fa-moon';
    }

    function updateTimestamp() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        document.getElementById('last-updated').innerHTML = `<i class="fas fa-clock me-1"></i> UPDATED: ${timeStr}`;
    }

    function initializeApp() {
        initTheme();
        db.ref('detailed_productivity').on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                rawData = Object.values(data);
            } else {
                rawData = [...mockData];
            }
            processAndRender();
        }, (error) => {
            rawData = [...mockData];
            processAndRender();
        });
    }

    function processAndRender() {
        rawData.sort((a, b) => b.Qty - a.Qty);
        updateAnalytics(); // Calculate totalAchievedValue first
        renderTable(rawData);
        updateTimestamp();
        applyWebFilters(); 
    }

    function renderTable(data) {
        const tableBody = document.getElementById('user-table-body');
        tableBody.innerHTML = "";
        
        data.forEach((row) => {
            // Calculate contribution percentage relative to global achieved total
            const contribution = totalAchievedValue > 0 ? ((row.Qty / totalAchievedValue) * 100).toFixed(1) : 0;
            
            tableBody.innerHTML += `
                <tr class="user-row" data-bldg="${row.Building}" data-dept="${row.Department}">
                    <td class="text-start ps-4 py-3 fw-bold">${row.Actor}</td>
                    <td class="text-end text-info fw-bold mb-0">${row.Qty.toLocaleString()}</td>
                    <td class="text-end pe-4 text-contribution">${contribution}%</td>
                </tr>`;
        });
    }

    function applyWebFilters() {
        const bldgSelect = document.getElementById('bldg-filter');
        const deptSelect = document.getElementById('dept-filter');
        const bldgVal = bldgSelect.value;
        const deptVal = deptSelect.value;
        const rows = document.querySelectorAll('.user-row');

        rows.forEach(row => {
            const bMatch = bldgVal === 'all' || row.getAttribute('data-bldg').includes(bldgVal);
            const dMatch = deptVal === 'all' || row.getAttribute('data-dept') === deptVal;
            row.style.display = (bMatch && dMatch) ? "" : "none";
        });

        const bldgText = bldgSelect.options[bldgSelect.selectedIndex].text;
        const deptText = deptSelect.options[deptSelect.selectedIndex].text;
        
        document.getElementById('summary-bldg').innerHTML = `<i class="fas fa-building me-1 small opacity-50"></i> ${bldgText.toUpperCase()}`;
        document.getElementById('summary-dept').innerHTML = `<i class="fas fa-layer-group me-1 small opacity-50"></i> ${deptText.toUpperCase()}`;
    }

    function toggleSort() {
        sortAsc = !sortAsc;
        rawData.sort((a, b) => sortAsc ? a.Qty - b.Qty : b.Qty - a.Qty);
        renderTable(rawData);
        applyWebFilters();
    }

    function updateAnalytics() {
        const chartDeptFilter = document.getElementById('chart-dept-filter').value;
        
        let b3Global = 0, b5Global = 0;
        let b3Filtered = 0, b5Filtered = 0;

        rawData.forEach(r => {
            // Global sum for the stat cards (Target/Achieved usually reflects global state)
            if(r.Building.toLowerCase().includes('bldg3')) b3Global += r.Qty;
            if(r.Building.toLowerCase().includes('bldg5')) b5Global += r.Qty;

            // Filtered sum for the chart
            const deptMatch = (chartDeptFilter === 'all' || r.Department === chartDeptFilter);
            if (deptMatch) {
                if(r.Building.toLowerCase().includes('bldg3')) b3Filtered += r.Qty;
                if(r.Building.toLowerCase().includes('bldg5')) b5Filtered += r.Qty;
            }
        });

        totalAchievedValue = b3Global + b5Global;

        db.ref('productivity').once('value', (s) => {
            const val = s.val();
            const target = (val && val.target) ? val.target : 2500;
            document.getElementById('target-val').innerText = target.toLocaleString();
            document.getElementById('achieved-val').innerText = totalAchievedValue.toLocaleString();
            updateChart(b3Filtered, b5Filtered, target);
        }, (err) => {
            const target = 2500;
            document.getElementById('target-val').innerText = target.toLocaleString();
            document.getElementById('achieved-val').innerText = totalAchievedValue.toLocaleString();
            updateChart(b3Filtered, b5Filtered, target);
        });
    }

    function updateChart(b3, b5, target) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        const achieved = b3 + b5;
        const remaining = Math.max(0, target - achieved);
        const labelColor = getComputedStyle(document.body).getPropertyValue('--text-muted').trim();

        if (chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Bldg 3', 'Bldg 5', 'Remaining'],
                datasets: [{
                    data: [b3, b5, remaining],
                    backgroundColor: ['#38bdf8', '#818cf8', '#94a3b833'],
                    hoverOffset: 15,
                    borderWidth: 0,
                    borderRadius: 5
                }]
            },
            options: { 
                maintainAspectRatio: false,
                cutout: '70%', 
                plugins: { 
                    legend: { 
                        position: 'bottom', 
                        labels: { color: labelColor, padding: 20, usePointStyle: true, font: { size: 12, weight: '500' } } 
                    }
                } 
            }
        });
    }

    window.onload = initializeApp;
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
