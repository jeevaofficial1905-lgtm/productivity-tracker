<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Management MIS | Professional</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; }
        body { background-color: var(--bg); color: #f1f5f9; font-family: 'Inter', sans-serif; }
        .nav-pills { background: var(--card); padding: 5px; border-radius: 50px; width: fit-content; margin: 15px auto; }
        .nav-link { color: #94a3b8; border-radius: 50px !important; padding: 8px 20px; border: none; font-size: 0.9rem; }
        .nav-link.active { background: var(--accent) !important; color: #000 !important; font-weight: 600; }
        .stat-card { background: var(--card); border: 1px solid #334155; border-radius: 12px; padding: 15px; }
        .filter-select { background-color: #334155; color: white; border: 1px solid #475569; border-radius: 8px; font-size: 0.85rem; }
        .table-container { background: var(--card); border-radius: 12px; overflow: hidden; border: 1px solid #334155; }
        .table { margin-bottom: 0; font-size: 0.85rem; vertical-align: middle; }
        .table thead { background: #334155; color: var(--accent); }
    </style>
</head>
<body>

<div class="container py-3">
    <header class="text-center mb-3">
        <h6 class="fw-bold text-uppercase tracking-wider">Productivity Monitoring Hub</h6>
    </header>

    <ul class="nav nav-pills shadow-sm" id="pills-tab" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#view-chart">Analytics</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#view-table">User Details</button></li>
    </ul>

    <div class="tab-content" id="pills-tabContent">
        <div class="tab-pane fade show active" id="view-chart">
            <div class="row g-2 mb-3 text-center">
                <div class="col-6"><div class="stat-card"><small class="text-muted d-block">TARGET</small><span id="target-val" class="h4 fw-bold">0</span></div></div>
                <div class="col-6"><div class="stat-card"><small class="text-muted d-block">ACHIEVED</small><span id="achieved-val" class="h4 fw-bold text-info">0</span></div></div>
            </div>
            <div class="stat-card">
                <canvas id="mainChart" style="max-height: 280px;"></canvas>
            </div>
        </div>

        <div class="tab-pane fade" id="view-table">
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <select id="bldg-filter" class="form-select filter-select" onchange="applyWebFilters()">
                        <option value="all">All Buildings</option>
                        <option value="bldg3">Bldg 3</option>
                        <option value="bldg5">Bldg 5</option>
                    </select>
                </div>
                <div class="col-6">
                    <select id="dept-filter" class="form-select filter-select" onchange="applyWebFilters()">
                        <option value="all">All Depts</option>
                        <option value="GRN">GRN</option>
                    </select>
                </div>
            </div>

            <div class="table-container shadow">
                <table class="table table-dark table-striped text-center" id="user-table">
                    <thead>
                        <tr>
                            <th>Bldg</th>
                            <th>Dept</th>
                            <th>Actor</th>
                            <th onclick="toggleSort()" style="cursor:pointer">Qty <i class="fas fa-sort small ms-1"></i></th>
                        </tr>
                    </thead>
                    <tbody id="user-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://productivity-tracker-e3538-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let chart;
    let rawData = [];
    let sortAsc = false;

    // Listen for Detailed List
    db.ref('detailed_productivity').on('value', (snapshot) => {
        rawData = [];
        snapshot.forEach((child) => { rawData.push(child.val()); });
        
        // Initial Sort (Highest Qty First)
        rawData.sort((a, b) => b.Qty - a.Qty);
        
        renderTable(rawData);
        updateAnalytics();
    });

    function renderTable(data) {
        const tableBody = document.getElementById('user-table-body');
        tableBody.innerHTML = "";
        data.forEach((row) => {
            tableBody.innerHTML += `
                <tr class="user-row" data-bldg="${row.Building}" data-dept="${row.Department}">
                    <td class="small text-muted">${row.Building.includes('bldg3') ? 'B3' : 'B5'}</td>
                    <td><span class="badge bg-secondary" style="font-size: 0.7rem;">${row.Department}</span></td>
                    <td class="fw-bold">${row.Actor}</td>
                    <td class="text-info fw-bold">${row.Qty}</td>
                </tr>`;
        });
    }

    // Professional Filtering Logic (Building & Dept Wise)
    function applyWebFilters() {
        const bldgVal = document.getElementById('bldg-filter').value;
        const deptVal = document.getElementById('dept-filter').value;
        const rows = document.querySelectorAll('.user-row');

        rows.forEach(row => {
            const bMatch = bldgVal === 'all' || row.getAttribute('data-bldg').includes(bldgVal);
            const dMatch = deptVal === 'all' || row.getAttribute('data-dept'] === deptVal;
            row.style.display = (bMatch && dMatch) ? "" : "none";
        });
    }

    // Sorting Option in Qty
    function toggleSort() {
        sortAsc = !sortAsc;
        rawData.sort((a, b) => sortAsc ? a.Qty - b.Qty : b.Qty - a.Qty);
        renderTable(rawData);
        applyWebFilters();
    }

    function updateAnalytics() {
        let b3 = 0, b5 = 0;
        rawData.forEach(r => {
            if(r.Building.includes('bldg3')) b3 += r.Qty;
            if(r.Building.includes('bldg5')) b5 += r.Qty;
        });

        db.ref('productivity').once('value', (s) => {
            const target = s.val() ? s.val().target : 0;
            document.getElementById('target-val').innerText = target;
            document.getElementById('achieved-val').innerText = (b3 + b5);
            updateChart(b3, b5, target);
        });
    }

    function updateChart(b3, b5, target) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        const achieved = b3 + b5;
        const remaining = Math.max(0, target - achieved);

        if (chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Bldg 3', 'Bldg 5', 'Remaining'],
                datasets: [{
                    data: [b3, b5, remaining],
                    backgroundColor: ['#81c784', '#2e7d32', '#424242'], // 3-Color Logic
                    borderWidth: 0
                }]
            },
            options: { cutout: '75%', plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8', font: { size: 11 } } } } }
        });
    }
</script>
</body>
</html>
