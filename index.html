<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Management MIS | Professional</title>
    <!-- External Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root { 
            --bg: #f8fafc;
            --card: #ffffff;
            --accent: #0284c7;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --table-header: #f8fafc;
            --table-hover: rgba(2, 132, 199, 0.03);
            --nav-bg: #ffffff;
            --update-bg: rgba(2, 132, 199, 0.05);
        }

        body.dark-mode {
            --bg: #0f172a; 
            --card: #1e293b; 
            --accent: #38bdf8; 
            --text-main: #f1f5f9;
            --text-muted: #cbd5e1; 
            --border: #334155;
            --table-header: #1e293b;
            --table-hover: rgba(56, 189, 248, 0.05);
            --nav-bg: #1e293b;
            --update-bg: rgba(56, 189, 248, 0.1);
        }
        
        body { 
            background-color: var(--bg); 
            color: var(--text-main); 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; 
            min-height: 100vh;
            transition: all 0.3s ease;
            overflow-x: hidden;
        }

        /* Mobile Adjustments for "Perfect" Look */
        @media (max-width: 576px) {
            .container { padding-left: 15px; padding-right: 15px; }
            .stat-card { padding: 15px !important; }
            .h3 { font-size: 1.3rem !important; }
            .h2 { font-size: 1.5rem !important; }
            .nav-link { padding: 10px 18px !important; font-size: 0.85rem !important; }
            header h6 { font-size: 1.05rem !important; }
            .table { font-size: 0.85rem !important; }
        }

        /* Header Styles */
        .hub-title { font-weight: 800; color: var(--accent); letter-spacing: 1px; }
        
        #timestamp-badge {
            display: inline-flex;
            align-items: center;
            background: var(--update-bg);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 2px 10px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.75rem;
            margin-top: 5px;
        }

        /* Navigation Pills */
        .nav-pills { 
            background: var(--nav-bg); 
            padding: 5px; 
            border-radius: 50px; 
            width: fit-content; 
            margin: 15px auto 25px; 
            border: 1px solid var(--border);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .nav-link { 
            color: var(--text-muted); 
            border-radius: 50px !important; 
            padding: 10px 24px; 
            border: none; 
            font-size: 0.9rem; 
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .nav-link.active { 
            background: var(--accent) !important; 
            color: white !important; 
            box-shadow: 0 4px 10px rgba(2, 132, 199, 0.3);
        }

        /* Stat Cards */
        .stat-card { 
            background: var(--card); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            padding: 20px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
            height: 100%;
        }

        .stat-label {
            color: var(--text-muted);
            display: block;
            margin-bottom: 5px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.65rem;
        }

        /* Filter Selects */
        .filter-select { 
            background-color: var(--card); 
            color: var(--text-main); 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            font-size: 0.9rem; 
            padding: 10px;
            font-weight: 500;
        }

        .chart-filter {
            padding: 3px 10px;
            font-size: 0.75rem;
            background: var(--card);
            color: var(--text-muted);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-weight: 600;
        }

        /* Summary Banner */
        .active-filter-summary {
            background: var(--update-bg);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 12px;
            border-radius: 10px;
            font-weight: 800;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* Table Design */
        .table-container { 
            background: var(--card); 
            border-radius: 12px; 
            overflow: hidden; 
            border: 1px solid var(--border); 
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        }

        .table thead th { 
            background: var(--table-header); 
            color: var(--accent); 
            font-weight: 700;
            border-bottom: 1px solid var(--border);
            text-transform: uppercase;
            font-size: 0.7rem;
            padding: 15px 10px;
        }

        .table tbody tr { border-bottom: 1px solid var(--border); }
        .table tbody tr:last-child { border-bottom: none; }

        .text-contribution { color: var(--text-main); font-weight: 700; }

        /* Theme Toggle */
        .theme-toggle {
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--accent);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .tracking-wider { letter-spacing: 0.05em; }
    </style>
</head>
<body class="light-mode">

<div class="container py-3">
    <!-- Header Area -->
    <header class="d-flex justify-content-between align-items-start mb-2">
        <div class="flex-grow-1">
            <h6 class="hub-title text-uppercase mb-0">Productivity Hub</h6>
            <div id="timestamp-badge">
                <i class="far fa-clock me-2"></i><span id="live-clock">--:--:-- --</span>
            </div>
            <p class="text-muted small mb-0 fw-semibold mt-1">Management MIS Dashboard</p>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()">
            <i class="fas fa-cog" id="theme-icon"></i>
        </button>
    </header>

    <!-- Navigation -->
    <ul class="nav nav-pills" id="pills-tab" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#view-chart">
                <i class="fas fa-chart-pie me-2"></i>Analytics
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#view-table">
                <i class="fas fa-users-cog me-2"></i>User Details
            </button>
        </li>
    </ul>

    <div class="tab-content" id="pills-tabContent">
        <!-- ANALYTICS TAB -->
        <div class="tab-pane fade show active" id="view-chart">
            <div class="row g-3 mb-4 text-center">
                <div class="col-6">
                    <div class="stat-card" style="border-bottom: 2px solid var(--accent)">
                        <span class="stat-label">Target</span>
                        <span id="target-val" class="h2 fw-bold">24,500</span>
                    </div>
                </div>
                <div class="col-6">
                    <div class="stat-card">
                        <span class="stat-label">Achieved</span>
                        <span id="achieved-val" class="h2 fw-bold text-info">0</span>
                    </div>
                </div>
            </div>
            <div class="stat-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h6 class="m-0 fw-bold">Contribution</h6>
                    <select id="chart-dept-filter" class="form-select chart-filter w-auto" onchange="updateAnalytics()">
                        <option value="all">All Depts</option>
                        <option value="GRN">GRN</option>
                        <option value="Picking">Picking</option>
                    </select>
                </div>
                <div style="position: relative; height: 280px;">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
        </div>

        <!-- USER DETAILS TAB -->
        <div class="tab-pane fade" id="view-table">
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <select id="bldg-filter" class="form-select filter-select" onchange="applyWebFilters()">
                        <option value="all">All Buildings</option>
                        <option value="bldg3">Building 3</option>
                        <option value="bldg5">Building 5</option>
                    </select>
                </div>
                <div class="col-6">
                    <select id="dept-filter" class="form-select filter-select" onchange="applyWebFilters()">
                        <option value="all">All Depts</option>
                        <option value="GRN">GRN</option>
                        <option value="Picking">Picking</option>
                    </select>
                </div>
            </div>

            <div class="active-filter-summary mb-3">
                <span id="summary-bldg"><i class="fas fa-building small opacity-50 me-1"></i> BUILDING: ALL</span>
                <span class="opacity-25">|</span>
                <span id="summary-dept"><i class="fas fa-layer-group small opacity-50 me-1"></i> DEPT: ALL</span>
            </div>

            <div class="row g-2 mb-3">
                <div class="col-6">
                    <div class="stat-card p-2 text-center" style="border: none; background: rgba(0,0,0,0.02);">
                        <span class="stat-label" style="font-size: 0.55rem;">Total Actors</span>
                        <span id="total-actors-count" class="fw-bold h4 mb-0">0</span>
                    </div>
                </div>
                <div class="col-6">
                    <div class="stat-card p-2 text-center" style="border: none; background: rgba(0,0,0,0.02);">
                        <span class="stat-label" style="font-size: 0.55rem;">Total Quantity</span>
                        <span id="total-qty-sum" class="fw-bold h4 mb-0 text-info">0</span>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <table class="table table-hover text-center" id="user-table">
                    <thead>
                        <tr>
                            <th class="text-start ps-3">Actor</th>
                            <th class="text-end" onclick="toggleSort()" style="cursor:pointer">Qty <i class="fas fa-sort small ms-1"></i></th>
                            <th class="text-end pe-3">Contribution</th>
                        </tr>
                    </thead>
                    <tbody id="user-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://productivity-tracker-e3538-default-rtdb.firebaseio.com" };
    
    try {
        firebase.initializeApp(firebaseConfig);
    } catch (e) {}
    
    const db = firebase.database();
    let chart;
    let rawData = [];
    let sortAsc = false;
    let currentGlobalAchieved = 0;

    const DEPARTMENT_TARGETS = { 'all': 24500, 'GRN': 15000, 'Picking': 9500 };

    // High quality mock data to match screenshots
    const mockData = [
        { Building: "WMS_ENTOMA_B5", Department: "GRN", Actor: "anithadas", Qty: 1639 },
        { Building: "WMS_ENTOMA_B5", Department: "GRN", Actor: "nikita.m", Qty: 1618 },
        { Building: "WMS_ENTOMA_B5", Department: "GRN", Actor: "madhukumari", Qty: 1507 },
        { Building: "WMS_ENTOMA_B5", Department: "GRN", Actor: "priti.p", Qty: 1486 },
        { Building: "WMS_ENTOMA_B5", Department: "GRN", Actor: "sunilnahak", Qty: 1236 },
        { Building: "WMS_ENTOMA_B3", Department: "Picking", Actor: "tituswail", Qty: 1126 },
        { Building: "WMS_ENTOMA_B3", Department: "Picking", Actor: "ashok.marko", Qty: 984 },
        { Building: "WMS_ENTOMA_B5", Department: "GRN", Actor: "jaya", Qty: 928 },
        { Building: "WMS_ENTOMA_B3", Department: "Picking", Actor: "ranjith.dehury", Qty: 874 }
    ];

    function toggleTheme() {
        const isDark = document.body.classList.toggle('dark-mode');
        document.getElementById('theme-icon').className = isDark ? 'fas fa-sun' : 'fas fa-cog';
        updateAnalytics(); // Redraw chart for label colors
    }

    function updateClock() {
        const now = new Date();
        document.getElementById('live-clock').innerText = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }
    setInterval(updateClock, 1000);

    function initializeApp() {
        db.ref('detailed_productivity').on('value', (snapshot) => {
            const data = snapshot.val();
            rawData = data ? Object.values(data) : [...mockData];
            processAndRender();
        }, () => {
            rawData = [...mockData];
            processAndRender();
        });
    }

    function processAndRender() {
        rawData.sort((a, b) => Number(b.Qty || 0) - Number(a.Qty || 0));
        currentGlobalAchieved = rawData.reduce((acc, r) => acc + Number(r.Qty || 0), 0);
        
        updateAnalytics(); 
        renderTable(rawData);
        applyWebFilters(); 
    }

    function renderTable(data) {
        const tableBody = document.getElementById('user-table-body');
        tableBody.innerHTML = "";
        data.forEach((row) => {
            const qty = Number(row.Qty || 0);
            const contribution = currentGlobalAchieved > 0 ? ((qty / currentGlobalAchieved) * 100).toFixed(1) : 0;
            tableBody.innerHTML += `
                <tr class="user-row" data-bldg="${row.Building || ''}" data-dept="${row.Department || ''}" data-qty="${qty}">
                    <td class="text-start ps-3 py-3 fw-bold">${row.Actor || 'N/A'}</td>
                    <td class="text-end text-info fw-bold">${qty.toLocaleString()}</td>
                    <td class="text-end pe-3 text-contribution">${contribution}%</td>
                </tr>`;
        });
    }

    function applyWebFilters() {
        const bldgVal = document.getElementById('bldg-filter').value.toLowerCase();
        const deptVal = document.getElementById('dept-filter').value.toLowerCase();
        const rows = document.querySelectorAll('.user-row');

        let vCount = 0, vQty = 0;
        rows.forEach(row => {
            const rBldg = String(row.getAttribute('data-bldg')).toLowerCase();
            const rDept = String(row.getAttribute('data-dept')).toLowerCase();
            
            const bMatch = bldgVal === 'all' || rBldg.includes(bldgVal.replace('bldg', ''));
            const dMatch = deptVal === 'all' || rDept === deptVal;
            
            if (bMatch && dMatch) {
                row.style.display = "";
                vCount++;
                vQty += Number(row.getAttribute('data-qty'));
            } else {
                row.style.display = "none";
            }
        });

        document.getElementById('total-actors-count').innerText = vCount.toLocaleString();
        document.getElementById('total-qty-sum').innerText = vQty.toLocaleString();
        
        const bldgText = document.getElementById('bldg-filter').options[document.getElementById('bldg-filter').selectedIndex].text;
        const deptText = document.getElementById('dept-filter').options[document.getElementById('dept-filter').selectedIndex].text;
        document.getElementById('summary-bldg').innerHTML = `<i class="fas fa-building small opacity-50 me-1"></i> BUILDING: ${bldgText.toUpperCase()}`;
        document.getElementById('summary-dept').innerHTML = `<i class="fas fa-layer-group small opacity-50 me-1"></i> DEPT: ${deptText.toUpperCase()}`;
    }

    function updateAnalytics() {
        const filter = document.getElementById('chart-dept-filter').value;
        let b3 = 0, b5 = 0;

        rawData.forEach(r => {
            const rDept = String(r.Department || "").toLowerCase();
            const fDept = filter.toLowerCase();
            if (fDept === 'all' || rDept === fDept) {
                const bldg = String(r.Building || "").toLowerCase();
                const qty = Number(r.Qty || 0);
                if (bldg.includes('3')) b3 += qty;
                else if (bldg.includes('5')) b5 += qty;
            }
        });

        const achieved = b3 + b5;
        const target = DEPARTMENT_TARGETS[filter] || 24500;

        document.getElementById('achieved-val').innerText = achieved.toLocaleString();
        document.getElementById('target-val').innerText = target.toLocaleString();
        
        updateChart(b3, b5, target);
    }

    function toggleSort() {
        sortAsc = !sortAsc;
        rawData.sort((a, b) => sortAsc ? Number(a.Qty || 0) - Number(b.Qty || 0) : Number(b.Qty || 0) - Number(a.Qty || 0));
        renderTable(rawData);
        applyWebFilters();
    }

    function updateChart(b3, b5, target) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        const achieved = b3 + b5;
        const remaining = Math.max(0, target - achieved);
        const labelColor = getComputedStyle(document.body).getPropertyValue('--text-muted').trim();

        if (chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Bldg 3', 'Bldg 5', 'Remaining'],
                datasets: [{
                    data: [b3, b5, remaining],
                    backgroundColor: ['#38bdf8', '#818cf8', '#e2e8f0'],
                    hoverOffset: 10,
                    borderWidth: 0,
                    borderRadius: 4
                }]
            },
            options: { 
                maintainAspectRatio: false,
                cutout: '72%', 
                plugins: { 
                    legend: { position: 'bottom', labels: { color: labelColor, padding: 20, usePointStyle: true, font: { size: 11, weight: '700' } } }
                } 
            }
        });
    }

    window.onload = initializeApp;
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
