<script>
    const firebaseConfig = { databaseURL: "https://productivity-tracker-e3538-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let chart, rawData = [], DEPT_TARGETS = { 'all': 0, 'GRN': 0, 'Picking': 0, 'Packing': 0 };

    function initializeApp() {
        // --- TARGET LISTENER: FETCH FROM FIREBASE ---
        db.ref('productivity/targets').on('value', snap => {
            const targets = snap.val();
            if (targets) {
                DEPT_TARGETS['GRN'] = targets.GRN || 0;
                DEPT_TARGETS['Picking'] = targets.Picking || 0;
                DEPT_TARGETS['Packing'] = targets.Packing || 0;
                // Fetch the total total target pushed by EXE
                db.ref('productivity/total_target').once('value', tSnap => {
                    DEPT_TARGETS['all'] = tSnap.val() || 0;
                    updateAnalytics(); 
                });
            }
        });

        db.ref('detailed_productivity').on('value', snap => {
            rawData = snap.val() ? Object.values(snap.val()) : [];
            document.getElementById('last-updated-time').innerText = new Date().toLocaleTimeString();
            updateAnalytics();
            renderTable();
        });
    }

    function updateAnalytics() {
        const f = document.getElementById('chart-dept-filter').value;
        let b3 = 0, b5 = 0;
        rawData.forEach(r => {
            if (f === 'all' || r.Department === f) {
                if (r.Building.includes('3')) b3 += Number(r.Qty); else b5 += Number(r.Qty);
            }
        });
        // Use individual department target from Firebase
        const target = DEPT_TARGETS[f] || DEPT_TARGETS['all'];
        document.getElementById('achieved-val').innerText = (b3 + b5).toLocaleString();
        document.getElementById('target-val').innerText = target.toLocaleString();
        updateChart(b3, b5, target);
    }
    // ... Keep existing updateChart and renderTable functions ...
    window.onload = initializeApp;
</script>
